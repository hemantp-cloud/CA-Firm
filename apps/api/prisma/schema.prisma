// ============================================
// CA FIRM MANAGEMENT SYSTEM - SCHEMA V2.0
// ============================================
// Date: December 5, 2025
// Changes:
// - CA → PROJECT_MANAGER (complete rename)
// - TRAINEE → TEAM_MEMBER (complete rename)
// - Added SUPER_ADMIN role (Main Admin)
// - Separate tables for each role
// - Track creator for each user
// - Soft delete + Hard delete support
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN // Main Admin (Owner) - Only ONE
  ADMIN // Regular Admin
  PROJECT_MANAGER // Was CA
  TEAM_MEMBER // Was TRAINEE
  CLIENT // End Customer
}

enum ServiceStatus {
  // Creation Phase
  PENDING // Service created, not assigned yet

  // Assignment Phase
  ASSIGNED // Assigned to PM/TM, work not started

  // Execution Phase
  IN_PROGRESS // Work actively being done
  WAITING_FOR_CLIENT // Need client input/documents
  ON_HOLD // Temporarily paused

  // Review Phase
  UNDER_REVIEW // Submitted for quality check
  CHANGES_REQUESTED // Reviewer found issues

  // Completion Phase
  COMPLETED // All work done, approved
  DELIVERED // Sent to client

  // Billing Phase
  INVOICED // Invoice generated

  // Final States
  CLOSED // Fully done, paid
  CANCELLED // Service cancelled
}

// Service Origin - How was the service created?
enum ServiceOrigin {
  CLIENT_REQUEST // Client requested via portal
  FIRM_CREATED // SA/Admin/PM created directly
  RECURRING // Auto-created from schedule (future)
  COMPLIANCE // Compliance calendar triggered (future)
}

// Service Request Status - For client-initiated requests
enum RequestStatus {
  PENDING // Awaiting review
  UNDER_REVIEW // Being reviewed by PM/Admin
  APPROVED // Approved, converting to Service
  REJECTED // Rejected with reason
  CANCELLED // Cancelled by client
  CONVERTED // Successfully converted to Service
}

// Request Urgency - Priority levels for requests
enum RequestUrgency {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ServiceType {
  ITR_FILING
  GST_REGISTRATION
  GST_RETURN
  TDS_RETURN
  TDS_COMPLIANCE
  ROC_FILING
  AUDIT
  BOOK_KEEPING
  PAYROLL
  CONSULTATION
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum DocumentType {
  PAN_CARD
  AADHAR_CARD
  BANK_STATEMENT
  FORM_16
  FORM_26AS
  GST_CERTIFICATE
  INCORPORATION_CERTIFICATE
  PARTNERSHIP_DEED
  MOA_AOA
  AUDIT_REPORT
  BALANCE_SHEET
  PROFIT_LOSS
  TAX_RETURN
  OTHER
}

enum DocumentStatus {
  PENDING
  IN_PROGRESS
  REVIEWING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum PaymentMethod {
  CASH
  CHEQUE
  UPI
  NEFT
  RTGS
  CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Document Slot Status - Tracks the lifecycle of each document requirement
enum SlotStatus {
  NOT_STARTED    // Slot created, no action by PM yet
  LINKED         // PM linked an existing document from repository
  REQUESTED      // PM requested fresh upload from client
  UPLOADED       // Client uploaded a new document
  APPROVED       // PM approved the uploaded/linked document
  REJECTED       // PM rejected (client needs to re-upload)
}

// ============================================
// CORE MODELS
// ============================================

// Firm (Organization/Company)
model Firm {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  gstin     String?
  pan       String?
  website   String?
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  superAdmin      SuperAdmin?
  admins          Admin[]
  projectManagers ProjectManager[]
  teamMembers     TeamMember[]
  clients         Client[]
  services        Service[]
  documents       Document[]
  invoices        Invoice[]
  activityLogs    ActivityLog[]
  settings        Setting[]

  // NEW: Enhanced Service Workflow Relations
  clientPMAssignments  ClientPMAssignment[]
  serviceRequests      ServiceRequest[]
  serviceAssignments   ServiceAssignment[]
  serviceStatusHistory ServiceStatusHistory[]

  // NEW: Service Configuration Master Tables
  serviceCategories    ServiceCategory[]
  serviceTypeMasters   ServiceTypeMaster[]
  serviceSubTypes      ServiceSubType[]
  documentRequirements DocumentRequirement[]
  documentSlots        ServiceDocumentSlot[]  // NEW: Slot-based document tracking

  @@index([email])
  @@map("firms")
}

// ============================================
// USER ROLE MODELS (Separate Tables)
// ============================================

// Super Admin (Main Admin - Firm Owner)
// Only ONE per firm - Cannot be deleted
model SuperAdmin {
  id          String    @id @default(uuid())
  firmId      String    @unique // Only one Super Admin per firm
  email       String    @unique
  password    String
  name        String
  phone       String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Should always be null (Super Admin cannot be deleted)

  // Relations
  firm          Firm    @relation(fields: [firmId], references: [id], onDelete: Cascade)
  createdAdmins Admin[] @relation("CreatedBySuperAdmin")

  @@index([firmId])
  @@index([email])
  @@map("super_admins")
}

// Regular Admin (Created by Super Admin)
model Admin {
  id          String    @id @default(uuid())
  firmId      String
  createdBy   String // Super Admin ID who created this admin
  email       String    @unique
  password    String
  name        String
  phone       String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin ID who deleted this admin

  // Relations
  firm    Firm       @relation(fields: [firmId], references: [id], onDelete: Cascade)
  creator SuperAdmin @relation("CreatedBySuperAdmin", fields: [createdBy], references: [id], onDelete: Restrict)
  // Note: We track created users via createdBy field in their tables

  @@unique([firmId, email])
  @@index([firmId])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("admins")
}

// Project Manager (Was CA - Chartered Accountant)
model ProjectManager {
  id            String    @id @default(uuid())
  firmId        String
  createdBy     String // Super Admin or Admin ID
  createdByRole String // "SUPER_ADMIN" or "ADMIN"
  email         String    @unique
  password      String
  name          String
  phone         String?
  pan           String?
  address       String?
  city          String?
  state         String?
  pincode       String?
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Business details
  gstin      String?
  commission Decimal? @db.Decimal(5, 2) // Commission percentage

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin or Admin ID who deleted

  // Relations
  firm           Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  // Note: createdBy references SuperAdmin or Admin based on createdByRole
  // We don't use Prisma relations here to avoid conflicts
  // We track created users via createdBy field in their tables
  managedClients Client[]  @relation("ManagedByProjectManager")
  services       Service[]

  // NEW: Enhanced Service Workflow Relations
  clientAssignments  ClientPMAssignment[] // Many-to-Many with Clients
  serviceAssignments ServiceAssignment[] // Services assigned to this PM

  @@unique([firmId, email])
  @@index([firmId])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("project_managers")
}

// Team Member (Was TRAINEE - Junior Staff)
model TeamMember {
  id            String    @id @default(uuid())
  firmId        String
  createdBy     String // Super Admin, Admin, or Project Manager ID
  createdByRole String // "SUPER_ADMIN", "ADMIN", or "PROJECT_MANAGER"
  email         String    @unique
  password      String
  name          String
  phone         String?
  address       String?
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Team Member specific
  joiningDate DateTime @default(now())
  mentorId    String? // Optional: Assigned mentor Project Manager

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin, Admin, or Project Manager ID who deleted

  // Relations
  firm              Firm               @relation(fields: [firmId], references: [id], onDelete: Cascade)
  // Note: createdBy references SuperAdmin, Admin, or ProjectManager based on createdByRole
  // We don't use Prisma relations here to avoid conflicts
  tasks             Task[]
  documents         Document[]         @relation("TeamMemberDocuments")
  assignedDocuments Document[]         @relation("AssignedToTeamMember")
  clientAssignments ClientAssignment[]

  @@unique([firmId, email])
  @@index([firmId])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("team_members")
}

// Client (End Customer)
model Client {
  id            String    @id @default(uuid())
  firmId        String
  managedBy     String? // Project Manager ID who manages this client (optional)
  createdBy     String // Super Admin, Admin, or Project Manager ID
  createdByRole String // "SUPER_ADMIN", "ADMIN", or "PROJECT_MANAGER"
  email         String    @unique
  password      String
  name          String
  phone         String?
  pan           String?
  aadhar        String?
  address       String?
  city          String?
  state         String?
  pincode       String?
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Business details (if company)
  gstin       String?
  companyName String?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin, Admin, or Project Manager ID who deleted

  // Relations
  firm              Firm               @relation(fields: [firmId], references: [id], onDelete: Cascade)
  projectManager    ProjectManager?    @relation("ManagedByProjectManager", fields: [managedBy], references: [id], onDelete: SetNull)
  // Note: createdBy references SuperAdmin, Admin, or ProjectManager based on createdByRole
  // We don't use Prisma relations here to avoid conflicts
  services          Service[]
  documents         Document[]         @relation("ClientDocuments")
  invoices          Invoice[]
  clientAssignments ClientAssignment[]

  // NEW: Enhanced Service Workflow Relations
  pmAssignments   ClientPMAssignment[] // Many-to-Many with PMs
  serviceRequests ServiceRequest[] // Client-initiated requests
  documentSlots   ServiceDocumentSlot[]  // NEW: Slot-based document tracking

  @@unique([firmId, email])
  @@index([firmId])
  @@index([managedBy])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("clients")
}

// ============================================
// BUSINESS MODELS
// ============================================

// Service
model Service {
  id               String        @id @default(uuid())
  firmId           String
  clientId         String // Client who requested this service
  projectManagerId String? // Project Manager managing this service (legacy, kept for compatibility)
  title            String
  description      String?
  type             ServiceType
  status           ServiceStatus @default(PENDING)
  dueDate          DateTime?
  completedAt      DateTime?
  feeAmount        Decimal?      @db.Decimal(10, 2)
  notes            String? // Notes visible to client
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // ========== NEW ENHANCED WORKFLOW FIELDS ==========

  // Service Origin - How was this service created?
  origin           ServiceOrigin @default(FIRM_CREATED)
  serviceRequestId String?       @unique // If created from client request

  // Financial Year Tracking
  financialYear  String? // "2024-25"
  assessmentYear String? // "2025-26"

  // Current Assignment (Quick Access - denormalized for performance)
  currentAssigneeId   String? // PM or TM ID who is currently working
  currentAssigneeType String? // "PROJECT_MANAGER" or "TEAM_MEMBER"
  currentAssigneeName String? // For quick display without joins

  // Creation Tracking
  createdBy     String? // User ID who created this service
  createdByRole String? // "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "CLIENT"
  createdByName String? // For quick display

  // Work Dates
  startDate DateTime? // When work actually started

  // Internal Notes (Not visible to client)
  internalNotes String?

  // Priority/Urgency
  priority RequestUrgency @default(NORMAL)

  // Period Tracking (for quarterly/monthly services)
  quarter String? // "Q1", "Q2", "Q3", "Q4"
  period  String? // "2025-11" (YYYY-MM format for monthly services)

  // Document Requirements for this service
  // JSON array of selected documents:
  // [{ documentMasterId?: string, name: string, category: string, isRequired: boolean, isCustom: boolean }]
  requiredDocuments Json? // Documents selected during service creation

  // ========== SOFT DELETE (Recycle Bin) ==========

  // When deletedAt is set, the service is considered "in trash"
  deletedAt     DateTime? // When the service was moved to trash (null = not deleted)
  deletedBy     String?   // User ID who deleted this service
  deletedByName String?   // Name of user who deleted (for quick display)

  // ========== RELATIONS ==========

  // Existing Relations
  firm           Firm            @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  projectManager ProjectManager? @relation(fields: [projectManagerId], references: [id], onDelete: SetNull)
  tasks          Task[]
  documents      Document[]
  invoices       Invoice[]

  // NEW: Enhanced Workflow Relations
  serviceRequest ServiceRequest?        @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)
  assignments    ServiceAssignment[]
  statusHistory  ServiceStatusHistory[]
  documentSlots  ServiceDocumentSlot[]  // NEW: Slot-based document tracking

  @@index([firmId])
  @@index([clientId])
  @@index([projectManagerId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
  @@index([currentAssigneeId])
  @@index([origin])
  @@index([deletedAt])
  @@map("services")
}

// ============================================
// SERVICE DOCUMENT SLOT
// ============================================
// Tracks each document requirement for a service
// Enables linking existing docs or requesting new uploads

model ServiceDocumentSlot {
  id        String   @id @default(uuid())
  firmId    String
  serviceId String
  clientId  String   // Denormalized for quick access

  // Document Identification
  documentMasterId String?  // Reference to DocumentMaster (if from library)
  documentName     String   // "Form 16", "PAN Card" (display name)
  documentCode     String?  // "FORM_16", "PAN_CARD" (for matching)
  category         String?  // "Identity", "Tax", "Financial"
  description      String?  // Instructions for client

  // Requirement Details
  isRequired Boolean @default(true)
  isCustom   Boolean @default(false) // true if added as custom doc

  // Slot Status
  status SlotStatus @default(NOT_STARTED)

  // REQUEST Info (when PM requests from client)
  requestedAt     DateTime?
  requestedById   String?
  requestedByName String?
  deadline        DateTime?
  requestMessage  String?  // PM's instructions to client
  priority        String?  // "HIGH", "NORMAL", "LOW"

  // LINK Info (when PM links existing repository document)
  linkedDocumentId String?   // Points to existing Document in repository
  linkedAt         DateTime?
  linkedById       String?
  linkedByName     String?

  // UPLOAD Info (when client uploads FOR this slot)
  uploadedDocumentId String?   // Points to new Document uploaded for this slot
  uploadedAt         DateTime?

  // REVIEW Info (PM reviews uploaded document)
  reviewedAt     DateTime?
  reviewedById   String?
  reviewedByName String?
  rejectionReason String?  // If rejected, reason for re-upload

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  firm             Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  service          Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  client           Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  linkedDocument   Document? @relation("LinkedDocument", fields: [linkedDocumentId], references: [id], onDelete: SetNull)
  uploadedDocument Document? @relation("UploadedDocument", fields: [uploadedDocumentId], references: [id], onDelete: SetNull)

  @@index([firmId])
  @@index([serviceId])
  @@index([clientId])
  @@index([status])
  @@index([linkedDocumentId])
  @@index([uploadedDocumentId])
  @@map("service_document_slots")
}

// Task
model Task {
  id           String        @id @default(uuid())
  serviceId    String
  assignedToId String? // Team Member assigned to this task
  title        String
  description  String?
  status       ServiceStatus @default(PENDING)
  priority     Int           @default(0) // 0=Low, 1=Medium, 2=High
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  service    Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  assignedTo TeamMember? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([serviceId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

// Document
model Document {
  id             String         @id @default(uuid())
  firmId         String
  clientId       String? // Document belongs to Client (optional for self-documents)
  teamMemberId   String? // Team Member who uploaded (if applicable)
  serviceId      String? // Optional: linked to a service
  uploadedById   String? // ID of user who uploaded (Admin, SuperAdmin, PM, TM, Client)
  uploadedByRole String? // Role of uploader: "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "TEAM_MEMBER", "CLIENT"
  fileName       String
  fileType       String // MIME type
  fileSize       BigInt // Size in bytes
  storagePath    String // Path to file in storage
  folderPath     String? // Organized folder path
  documentType   DocumentType?
  description    String?
  version        Int            @default(1)
  status         DocumentStatus @default(PENDING)
  uploadStatus   String         @default("DRAFT") // "DRAFT" or "SUBMITTED"
  submittedAt    DateTime?
  assignedTo     String? // Team Member who picked this work
  approvedAt     DateTime?
  uploadedAt     DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Hide/Restore functionality
  hiddenFrom String[]  @default([])
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  deletedBy  String?

  // Relations
  firm           Firm          @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client         Client?       @relation("ClientDocuments", fields: [clientId], references: [id], onDelete: Cascade)
  teamMember     TeamMember?   @relation("TeamMemberDocuments", fields: [teamMemberId], references: [id], onDelete: SetNull)
  service        Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  assignedToUser TeamMember?   @relation("AssignedToTeamMember", fields: [assignedTo], references: [id], onDelete: SetNull)
  activityLogs   ActivityLog[]

  // NEW: Slot relations (a document can be linked or uploaded to multiple slots)
  linkedToSlots   ServiceDocumentSlot[] @relation("LinkedDocument")
  uploadedToSlots ServiceDocumentSlot[] @relation("UploadedDocument")

  @@index([firmId])
  @@index([clientId])
  @@index([teamMemberId])
  @@index([serviceId])
  @@index([documentType])
  @@index([uploadStatus])
  @@index([assignedTo])
  @@index([uploadedById])
  @@index([uploadedByRole])
  @@map("documents")
}

// Invoice
model Invoice {
  id            String        @id @default(uuid())
  firmId        String
  clientId      String // Invoice for Client
  serviceId     String? // Optional: linked to a service
  invoiceNumber String        @unique
  invoiceDate   DateTime
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(10, 2)
  taxRate       Decimal       @default(18.00) @db.Decimal(5, 2)
  taxAmount     Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0.00) @db.Decimal(10, 2)
  totalAmount   Decimal       @db.Decimal(10, 2)
  status        InvoiceStatus @default(DRAFT)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  firm     Firm          @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client   Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service  Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  items    InvoiceItem[]
  payments Payment[]

  @@index([firmId])
  @@index([clientId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// Invoice Item
model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal  @default(1.00) @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  taxRate     Decimal  @default(18.00) @db.Decimal(5, 2)
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// Payment
model Payment {
  id             String        @id @default(uuid())
  invoiceId      String
  amount         Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus @default(PENDING)
  paymentDate    DateTime
  transactionRef String?
  bankName       String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentStatus])
  @@index([paymentDate])
  @@map("payments")
}

// Client Assignment (Team Member-Client relationship)
model ClientAssignment {
  id           String   @id @default(uuid())
  teamMemberId String
  clientId     String
  assignedBy   String // Admin/SuperAdmin/ProjectManager who made the assignment
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, clientId])
  @@index([teamMemberId])
  @@index([clientId])
  @@index([assignedBy])
  @@map("client_assignments")
}

// Activity Log
model ActivityLog {
  id         String   @id @default(uuid())
  firmId     String
  userId     String? // ID of user who performed action
  userType   String? // "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "TEAM_MEMBER", "CLIENT"
  documentId String?
  action     String // CREATE, UPDATE, DELETE, LOGIN, UPLOAD, etc.
  entityType String // User, Service, Invoice, Document, etc.
  entityId   String?
  entityName String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  firm     Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  // Note: userId references different tables based on userType
  // We don't use Prisma relations here to avoid conflicts

  @@index([firmId])
  @@index([userId])
  @@index([userType])
  @@index([documentId])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_logs")
}

// Setting
model Setting {
  id          String   @id @default(uuid())
  firmId      String
  key         String
  value       String
  category    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  firm Firm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, key])
  @@index([firmId])
  @@index([category])
  @@map("settings")
}

// ============================================
// ENHANCED SERVICE WORKFLOW MODELS
// ============================================

// ClientPMAssignment (Many-to-Many Client-PM Relationship)
// Replaces the old one-to-one managedBy relationship
// One client can have multiple PMs with different roles
model ClientPMAssignment {
  id               String @id @default(uuid())
  firmId           String
  clientId         String
  projectManagerId String

  // Role of this PM for this client
  role  String? // "PRIMARY", "GST_HANDLER", "ITR_HANDLER", "AUDIT_HANDLER", etc.
  notes String? // Additional notes about this assignment

  // Audit Trail
  assignedBy     String // User ID who created this assignment
  assignedByRole String // "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER"
  assignedByName String // For quick display
  assignedAt     DateTime @default(now())

  // Status
  isActive      Boolean   @default(true)
  removedAt     DateTime?
  removedBy     String?
  removedByRole String?
  removalReason String?

  // Relations
  firm           Firm           @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client         Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  projectManager ProjectManager @relation(fields: [projectManagerId], references: [id], onDelete: Cascade)

  @@unique([clientId, projectManagerId]) // One PM per client per assignment
  @@index([firmId])
  @@index([clientId])
  @@index([projectManagerId])
  @@index([isActive])
  @@map("client_pm_assignments")
}

// ServiceRequest (Client-Initiated Service Request)
// When client requests a new service, it goes through approval workflow
model ServiceRequest {
  id       String @id @default(uuid())
  firmId   String
  clientId String

  // Request Details
  serviceType      ServiceType
  title            String
  description      String?
  urgency          RequestUrgency @default(NORMAL)
  preferredDueDate DateTime?
  financialYear    String? // "2024-25"
  assessmentYear   String? // "2025-26"

  // Request Status
  status RequestStatus @default(PENDING)

  // Review Information
  reviewedBy      String? // PM/Admin who reviewed
  reviewedByRole  String?
  reviewedByName  String?
  reviewedAt      DateTime?
  rejectionReason String?
  approvalNotes   String?

  // Quoted Fee (can be set during approval)
  quotedFee Decimal? @db.Decimal(10, 2)

  // Link to created Service (after approval)
  convertedToService Service? // One-to-one relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  firm        Firm                @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client      Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  attachments RequestAttachment[]

  @@index([firmId])
  @@index([clientId])
  @@index([status])
  @@index([serviceType])
  @@index([createdAt])
  @@map("service_requests")
}

// RequestAttachment (Files attached to Service Request)
model RequestAttachment {
  id          String   @id @default(uuid())
  requestId   String
  fileName    String
  fileType    String // MIME type
  fileSize    BigInt // Size in bytes
  storagePath String // Path to file in storage
  uploadedAt  DateTime @default(now())

  // Relations
  request ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("request_attachments")
}

// ServiceAssignment (Assignment & Delegation Tracking)
// Tracks who is assigned to work on a service
// Supports chain delegation: PM can delegate to TM, TM can delegate to another TM
model ServiceAssignment {
  id        String @id @default(uuid())
  firmId    String
  serviceId String

  // Assignee Information
  assigneeId   String // PM or TM ID
  assigneeType String // "PROJECT_MANAGER" or "TEAM_MEMBER"
  assigneeName String // For quick display

  // Assigner Information (Who made this assignment)
  assignedBy     String // User ID
  assignedByType String // "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "TEAM_MEMBER"
  assignedByName String // For quick display

  // Chain Delegation Tracking
  delegationLevel      Int     @default(1) // 1 = initial, 2 = first delegation, etc.
  previousAssignmentId String? // Link to previous assignment in chain
  delegationReason     String? // Why was it delegated?

  // Assignment Type
  assignmentType String // "INITIAL", "DELEGATION", "RE_ASSIGNMENT", "TAKE_BACK"

  // Status
  status String @default("ACTIVE") // "ACTIVE", "DELEGATED", "COMPLETED", "REVOKED"

  // Timestamps
  assignedAt    DateTime  @default(now())
  acceptedAt    DateTime? // When assignee accepted
  completedAt   DateTime? // When assignee completed work
  revokedAt     DateTime?
  revokedBy     String?
  revokedReason String?

  // Relations
  firm           Firm            @relation(fields: [firmId], references: [id], onDelete: Cascade)
  service        Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  projectManager ProjectManager? @relation(fields: [assigneeId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@index([serviceId])
  @@index([assigneeId])
  @@index([status])
  @@index([delegationLevel])
  @@map("service_assignments")
}

// ServiceStatusHistory (Complete Audit Trail)
// Records every status change with full context
model ServiceStatusHistory {
  id        String @id @default(uuid())
  firmId    String
  serviceId String

  // Status Change
  fromStatus ServiceStatus? // null for initial creation
  toStatus   ServiceStatus

  // Action that triggered this change
  action String // "CREATE", "ASSIGN", "START_WORK", "REQUEST_DOCUMENTS", etc.

  // Who made the change
  changedBy     String // User ID
  changedByType String // "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "TEAM_MEMBER", "CLIENT", "SYSTEM"
  changedByName String // For quick display

  // Context
  reason   String? // Optional reason for status change
  notes    String? // Additional notes
  metadata Json? // Additional structured data (e.g., document list for WAITING_FOR_CLIENT)

  changedAt DateTime @default(now())

  // Relations
  firm    Firm    @relation(fields: [firmId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@index([serviceId])
  @@index([action])
  @@index([changedAt])
  @@map("service_status_history")
}

// ============================================
// SERVICE CONFIGURATION MASTER TABLES
// ============================================

// ServiceCategory - Top-level service categories
// System defaults + firm-level customization
model ServiceCategory {
  id          String  @id @default(uuid())
  firmId      String? // NULL = system default, applies to all firms
  code        String  // "INCOME_TAX", "GST", "ROC_MCA", etc.
  name        String  // "Income Tax Services"
  description String?
  icon        String? // Icon name for UI
  displayOrder Int    @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  firm         Firm?              @relation(fields: [firmId], references: [id], onDelete: Cascade)
  serviceTypes ServiceTypeMaster[]

  @@unique([firmId, code])
  @@index([firmId])
  @@index([isActive])
  @@map("service_categories")
}

// ServiceTypeMaster - Service types within a category
// E.g., "ITR Filing", "TDS Return" under Income Tax
model ServiceTypeMaster {
  id         String @id @default(uuid())
  categoryId String
  firmId     String? // NULL = system default

  code        String  // "ITR_FILING", "GST_RETURN", "TAX_AUDIT"
  name        String  // "ITR Filing"
  description String?
  frequency   String? // "Monthly", "Quarterly", "Annual"
  deliverables String[] @default([]) // Array of deliverables for this service

  // Configuration flags
  hasSubTypes           Boolean @default(false) // Does this type have sub-types?
  requiresFinancialYear Boolean @default(true)
  requiresAssessmentYear Boolean @default(false)
  requiresQuarter       Boolean @default(false)
  requiresPeriod        Boolean @default(false) // For monthly returns

  // Defaults
  defaultDueDays  Int?     // Days from creation to due date
  defaultDueDate  String?  // Fixed date like "July 31" or "11th of month"
  defaultFee      Decimal? @db.Decimal(10, 2)

  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category     ServiceCategory         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  firm         Firm?                   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  subTypes     ServiceSubType[]
  documentRequirements DocumentRequirement[]

  @@unique([firmId, code])
  @@index([categoryId])
  @@index([firmId])
  @@index([isActive])
  @@map("service_type_masters")
}

// ServiceSubType - Sub-types for granular services
// E.g., "ITR-1 (Salaried)", "ITR-3 (Business)" under ITR Filing
model ServiceSubType {
  id            String @id @default(uuid())
  serviceTypeId String
  firmId        String? // NULL = system default

  code        String  // "ITR_1", "ITR_3", "GSTR_1", "GSTR_3B"
  name        String  // "ITR-1 (Salaried Individual)"
  description String?

  // Who is this for?
  applicableTo String? // "Salaried individuals with income ≤ ₹50L"

  // Due date reference
  dueDateReference String? // "July 31", "11th of month", etc.

  // Deliverables for this specific sub-type (progressive disclosure)
  deliverables String[] @default([])

  // Default fee override
  defaultFee Decimal? @db.Decimal(10, 2)

  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  serviceType  ServiceTypeMaster       @relation(fields: [serviceTypeId], references: [id], onDelete: Cascade)
  firm         Firm?                   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  documentRequirements DocumentRequirement[]

  @@unique([serviceTypeId, code])
  @@index([serviceTypeId])
  @@index([firmId])
  @@index([isActive])
  @@map("service_sub_types")
}

// DocumentMaster - Universal Document Library
// Contains ALL possible documents that can be required for any service
// This is the master list from which users select documents
model DocumentMaster {
  id          String  @id @default(uuid())
  code        String  @unique // "PAN_CARD", "FORM_16", etc.
  name        String  // "PAN Card", "Form 16", etc.
  category    String  // "Identity", "Financial", "Tax", "Business"
  description String? // Optional description of the document

  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("document_masters")
}

// DocumentRequirement - Documents required for each service type
// Pre-populated from implementation_Plan.md document requirements
model DocumentRequirement {
  id             String  @id @default(uuid())
  serviceTypeId  String
  serviceSubTypeId String? // Optional - for sub-type specific requirements
  firmId         String? // NULL = system default

  documentName String  // "Form 16", "PAN Card", "Bank Statement"
  description  String? // "TDS Certificate from employer"
  category     String? // "Identity", "Financial", "Tax", "Business"

  isMandatory  Boolean @default(true)
  displayOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  serviceType    ServiceTypeMaster @relation(fields: [serviceTypeId], references: [id], onDelete: Cascade)
  serviceSubType ServiceSubType?   @relation(fields: [serviceSubTypeId], references: [id], onDelete: Cascade)
  firm           Firm?             @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@index([serviceTypeId])
  @@index([serviceSubTypeId])
  @@index([firmId])
  @@map("document_requirements")
}
