// ============================================
// CA FIRM MANAGEMENT SYSTEM - SCHEMA V2.0
// ============================================
// Date: December 5, 2025
// Changes:
// - CA → PROJECT_MANAGER (complete rename)
// - TRAINEE → TEAM_MEMBER (complete rename)
// - Added SUPER_ADMIN role (Main Admin)
// - Separate tables for each role
// - Track creator for each user
// - Soft delete + Hard delete support
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN      // Main Admin (Owner) - Only ONE
  ADMIN            // Regular Admin
  PROJECT_MANAGER  // Was CA
  TEAM_MEMBER      // Was TRAINEE
  CLIENT           // End Customer
}

enum ServiceStatus {
  PENDING
  IN_PROGRESS
  UNDER_REVIEW
  COMPLETED
  CANCELLED
}

enum ServiceType {
  ITR_FILING
  GST_REGISTRATION
  GST_RETURN
  TDS_RETURN
  TDS_COMPLIANCE
  ROC_FILING
  AUDIT
  BOOK_KEEPING
  PAYROLL
  CONSULTATION
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum DocumentType {
  PAN_CARD
  AADHAR_CARD
  BANK_STATEMENT
  FORM_16
  FORM_26AS
  GST_CERTIFICATE
  INCORPORATION_CERTIFICATE
  PARTNERSHIP_DEED
  MOA_AOA
  AUDIT_REPORT
  BALANCE_SHEET
  PROFIT_LOSS
  TAX_RETURN
  OTHER
}

enum DocumentStatus {
  PENDING
  IN_PROGRESS
  REVIEWING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum PaymentMethod {
  CASH
  CHEQUE
  UPI
  NEFT
  RTGS
  CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================
// CORE MODELS
// ============================================

// Firm (Organization/Company)
model Firm {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  gstin     String?
  pan       String?
  website   String?
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  superAdmin       SuperAdmin?
  admins           Admin[]
  projectManagers  ProjectManager[]
  teamMembers      TeamMember[]
  clients          Client[]
  services         Service[]
  documents        Document[]
  invoices         Invoice[]
  activityLogs     ActivityLog[]
  settings         Setting[]

  @@index([email])
  @@map("firms")
}

// ============================================
// USER ROLE MODELS (Separate Tables)
// ============================================

// Super Admin (Main Admin - Firm Owner)
// Only ONE per firm - Cannot be deleted
model SuperAdmin {
  id          String    @id @default(uuid())
  firmId      String    @unique // Only one Super Admin per firm
  email       String    @unique
  password    String
  name        String
  phone       String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Should always be null (Super Admin cannot be deleted)

  // Relations
  firm                 Firm             @relation(fields: [firmId], references: [id], onDelete: Cascade)
  createdAdmins        Admin[]          @relation("CreatedBySuperAdmin")

  @@index([firmId])
  @@index([email])
  @@map("super_admins")
}

// Regular Admin (Created by Super Admin)
model Admin {
  id          String    @id @default(uuid())
  firmId      String
  createdBy   String // Super Admin ID who created this admin
  email       String    @unique
  password    String
  name        String
  phone       String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin ID who deleted this admin

  // Relations
  firm                 Firm             @relation(fields: [firmId], references: [id], onDelete: Cascade)
  creator              SuperAdmin       @relation("CreatedBySuperAdmin", fields: [createdBy], references: [id], onDelete: Restrict)
  // Note: We track created users via createdBy field in their tables

  @@unique([firmId, email])
  @@index([firmId])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("admins")
}

// Project Manager (Was CA - Chartered Accountant)
model ProjectManager {
  id          String    @id @default(uuid())
  firmId      String
  createdBy   String // Super Admin or Admin ID
  createdByRole String // "SUPER_ADMIN" or "ADMIN"
  email       String    @unique
  password    String
  name        String
  phone       String?
  pan         String?
  address     String?
  city        String?
  state       String?
  pincode     String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Business details
  gstin      String?
  commission Decimal? @db.Decimal(5, 2) // Commission percentage

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin or Admin ID who deleted

  // Relations
  firm                 Firm             @relation(fields: [firmId], references: [id], onDelete: Cascade)
  // Note: createdBy references SuperAdmin or Admin based on createdByRole
  // We don't use Prisma relations here to avoid conflicts
  // We track created users via createdBy field in their tables
  managedClients       Client[]         @relation("ManagedByProjectManager")
  services             Service[]

  @@unique([firmId, email])
  @@index([firmId])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("project_managers")
}

// Team Member (Was TRAINEE - Junior Staff)
model TeamMember {
  id          String    @id @default(uuid())
  firmId      String
  createdBy   String // Super Admin, Admin, or Project Manager ID
  createdByRole String // "SUPER_ADMIN", "ADMIN", or "PROJECT_MANAGER"
  email       String    @unique
  password    String
  name        String
  phone       String?
  address     String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Team Member specific
  joiningDate DateTime @default(now())
  mentorId    String? // Optional: Assigned mentor Project Manager

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin, Admin, or Project Manager ID who deleted

  // Relations
  firm                 Firm             @relation(fields: [firmId], references: [id], onDelete: Cascade)
  // Note: createdBy references SuperAdmin, Admin, or ProjectManager based on createdByRole
  // We don't use Prisma relations here to avoid conflicts
  tasks                Task[]
  documents            Document[]       @relation("TeamMemberDocuments")
  assignedDocuments    Document[]       @relation("AssignedToTeamMember")
  clientAssignments    ClientAssignment[]

  @@unique([firmId, email])
  @@index([firmId])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("team_members")
}

// Client (End Customer)
model Client {
  id          String    @id @default(uuid())
  firmId      String
  managedBy   String? // Project Manager ID who manages this client (optional)
  createdBy   String // Super Admin, Admin, or Project Manager ID
  createdByRole String // "SUPER_ADMIN", "ADMIN", or "PROJECT_MANAGER"
  email       String    @unique
  password    String
  name        String
  phone       String?
  pan         String?
  aadhar      String?
  address     String?
  city        String?
  state       String?
  pincode     String?
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Business details (if company)
  gstin       String?
  companyName String?

  // Email verification
  emailVerified           Boolean   @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password management
  mustChangePassword  Boolean   @default(false)
  passwordResetToken  String?
  passwordResetExpiry DateTime?

  // 2FA Support
  twoFactorEnabled Boolean   @default(false)
  otpCode          String?
  otpExpiry        DateTime?

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Soft delete support
  deletedAt DateTime?
  deletedBy String? // Super Admin, Admin, or Project Manager ID who deleted

  // Relations
  firm                 Firm             @relation(fields: [firmId], references: [id], onDelete: Cascade)
  projectManager       ProjectManager?  @relation("ManagedByProjectManager", fields: [managedBy], references: [id], onDelete: SetNull)
  // Note: createdBy references SuperAdmin, Admin, or ProjectManager based on createdByRole
  // We don't use Prisma relations here to avoid conflicts
  services             Service[]
  documents            Document[]       @relation("ClientDocuments")
  invoices             Invoice[]
  clientAssignments    ClientAssignment[]

  @@unique([firmId, email])
  @@index([firmId])
  @@index([managedBy])
  @@index([email])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("clients")
}

// ============================================
// BUSINESS MODELS
// ============================================

// Service
model Service {
  id                String        @id @default(uuid())
  firmId            String
  clientId          String // Client who requested this service
  projectManagerId  String? // Project Manager managing this service
  title             String
  description       String?
  type              ServiceType
  status            ServiceStatus @default(PENDING)
  dueDate           DateTime?
  completedAt       DateTime?
  feeAmount         Decimal?      @db.Decimal(10, 2)
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  firm           Firm            @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  projectManager ProjectManager? @relation(fields: [projectManagerId], references: [id], onDelete: SetNull)
  tasks          Task[]
  documents      Document[]
  invoices       Invoice[]

  @@index([firmId])
  @@index([clientId])
  @@index([projectManagerId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
  @@map("services")
}

// Task
model Task {
  id           String        @id @default(uuid())
  serviceId    String
  assignedToId String? // Team Member assigned to this task
  title        String
  description  String?
  status       ServiceStatus @default(PENDING)
  priority     Int           @default(0) // 0=Low, 1=Medium, 2=High
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  service    Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  assignedTo TeamMember? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([serviceId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

// Document
model Document {
  id           String         @id @default(uuid())
  firmId       String
  clientId     String? // Document belongs to Client (optional for self-documents)
  teamMemberId String? // Team Member who uploaded (if applicable)
  serviceId    String? // Optional: linked to a service
  uploadedById   String? // ID of user who uploaded (Admin, SuperAdmin, PM, TM, Client)
  uploadedByRole String? // Role of uploader: "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "TEAM_MEMBER", "CLIENT"
  fileName     String
  fileType     String // MIME type
  fileSize     BigInt // Size in bytes
  storagePath  String // Path to file in storage
  folderPath   String? // Organized folder path
  documentType DocumentType?
  description  String?
  version      Int            @default(1)
  status       DocumentStatus @default(PENDING)
  uploadStatus String         @default("DRAFT") // "DRAFT" or "SUBMITTED"
  submittedAt  DateTime?
  assignedTo   String? // Team Member who picked this work
  approvedAt   DateTime?
  uploadedAt   DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Hide/Restore functionality
  hiddenFrom String[]  @default([])
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  deletedBy  String?

  // Relations
  firm           Firm          @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client         Client?       @relation("ClientDocuments", fields: [clientId], references: [id], onDelete: Cascade)
  teamMember     TeamMember?   @relation("TeamMemberDocuments", fields: [teamMemberId], references: [id], onDelete: SetNull)
  service        Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  assignedToUser TeamMember?   @relation("AssignedToTeamMember", fields: [assignedTo], references: [id], onDelete: SetNull)
  activityLogs   ActivityLog[]

  @@index([firmId])
  @@index([clientId])
  @@index([teamMemberId])
  @@index([serviceId])
  @@index([documentType])
  @@index([uploadStatus])
  @@index([assignedTo])
  @@index([uploadedById])
  @@index([uploadedByRole])
  @@map("documents")
}

// Invoice
model Invoice {
  id            String        @id @default(uuid())
  firmId        String
  clientId      String // Invoice for Client
  serviceId     String? // Optional: linked to a service
  invoiceNumber String        @unique
  invoiceDate   DateTime
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(10, 2)
  taxRate       Decimal       @default(18.00) @db.Decimal(5, 2)
  taxAmount     Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0.00) @db.Decimal(10, 2)
  totalAmount   Decimal       @db.Decimal(10, 2)
  status        InvoiceStatus @default(DRAFT)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  firm     Firm          @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client   Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service  Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  items    InvoiceItem[]
  payments Payment[]

  @@index([firmId])
  @@index([clientId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// Invoice Item
model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal  @default(1.00) @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  taxRate     Decimal  @default(18.00) @db.Decimal(5, 2)
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// Payment
model Payment {
  id             String        @id @default(uuid())
  invoiceId      String
  amount         Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus @default(PENDING)
  paymentDate    DateTime
  transactionRef String?
  bankName       String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentStatus])
  @@index([paymentDate])
  @@map("payments")
}

// Client Assignment (Team Member-Client relationship)
model ClientAssignment {
  id           String     @id @default(uuid())
  teamMemberId String
  clientId     String
  assignedBy   String // Admin/SuperAdmin/ProjectManager who made the assignment
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, clientId])
  @@index([teamMemberId])
  @@index([clientId])
  @@index([assignedBy])
  @@map("client_assignments")
}

// Activity Log
model ActivityLog {
  id         String   @id @default(uuid())
  firmId     String
  userId     String? // ID of user who performed action
  userType   String? // "SUPER_ADMIN", "ADMIN", "PROJECT_MANAGER", "TEAM_MEMBER", "CLIENT"
  documentId String?
  action     String // CREATE, UPDATE, DELETE, LOGIN, UPLOAD, etc.
  entityType String // User, Service, Invoice, Document, etc.
  entityId   String?
  entityName String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  firm     Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  // Note: userId references different tables based on userType
  // We don't use Prisma relations here to avoid conflicts

  @@index([firmId])
  @@index([userId])
  @@index([userType])
  @@index([documentId])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_logs")
}

// Setting
model Setting {
  id          String   @id @default(uuid())
  firmId      String
  key         String
  value       String
  category    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  firm Firm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, key])
  @@index([firmId])
  @@index([category])
  @@map("settings")
}
